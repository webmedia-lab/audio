<!doctype html>
<html>
  <head>
    <script src="js/extensions.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <style>
      .note { border-bottom: 1px solid #555 }
      .container { margin: 20px 100px auto; }
    </style>
  </head>
  <body>
    <div class="container"></div>
  </body>
  <script type="text/javascript">

    window.Scale = function() {
      // Octave #4
      var _standardOctave = 4;
      var _standardNotes  = {
        'C': 261.6,
        'D': 293.7,
        'E': 329.6,
        'F': 349.2,
        'G': 392.0,
        'A': 440.0,
        'B': 493.9
      };

      self.get = function(note, octave) {
        return _standardNotes[note] * Math.pow(2, octave - _standardOctave);
      };

      return self;
    }

    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    window.Harp = function(context, scale){
      var self = {};

      var ctx = context;
      var scale = scale;
      var amplifier  = context.createGain();
      var oscillator = context.createOscillator();
      var isOn = false;

      oscillator.connect(amplifier);
      amplifier.connect(ctx.destination);
      oscillator.start(0);

      self.play = function(){
        oscillator.connect(amplifier);
        isOn = true;
      }

      self.stop = function(){
        oscillator.disconnect();
        isOn = false;
      }

      self.note = function(note, octave, intensity){
        oscillator.frequency.value = scale.get(note, octave);
        amplifier.gain.value = intensity;
      }


      self.scale = function(newScale){
        if(newScale) scale = newScale

        return scale
      }

      self.renderOn = function(container){
        container.innerHTML = '<input type="button" id="toogleSound" value="ON/OFF"/>';
        ['C','D','E','F','G','A','B'].forEach(function(note) {
          container.innerHTML += '<div class="note" data-note="' + note + '">'+ scale.get(note, 4) +'</div>';
        });

        var height = (window.innerHeight - 100) / 8 + 'px';
        document.querySelectorAll('.note').each(function(e){
          e.style.height = height;
          e.addEventListener('mouseenter', function(e){
            console.log(e.target.dataset.note);
            window.harp.note(e.target.dataset.note, 4, 0.5)
          });

          e.addEventListener('touchmove', function(e){
            e.preventDefault();
            console.log(e.target.dataset.note);
            window.harp.note(e.target.dataset.note, 4, 0.5)
          });
        });

        document.getElementById("toogleSound").addEventListener('click', function(e) {
          isOn ? window.harp.stop() : window.harp.play();
        });
      }

      return self;
    }

    window.addEventListener('load', function(){
      window.context = new AudioContext();
      window.scale = new Scale();
      window.harp = Harp(context, scale);

      harp.renderOn(document.querySelector('.container'));
      harp.play();
    });
  </script>
</html>
